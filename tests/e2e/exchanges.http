### Variables
@baseUrl = http://localhost:8080
# Usando IDs que sabemos que existen en la base de datos
@userId = 01284fa7-8a1e-463c-8b6c-c4fbaf13ca43
@requesterId = user-001
@ownerId = user-002
@ownerBookId = book-002
@requesterBookId = book-003

### Test 1: Create book exchange with dynamic data
# Este test crea un exchange y guarda su ID para usar en tests posteriores
POST {{baseUrl}}/exchanges
Content-Type: application/json
Authorization: {{token}}

{
  "requester_id": "{{requesterId}}",
  "owner_id": "{{ownerId}}",
  "owner_book_ids": ["{{ownerBookId}}"],
  "requester_book_ids": ["{{requesterBookId}}"]
}

> {%
client.test("Create exchange should return 201 or 409", function() {
    client.assert(response.status === 201 || response.status === 409, "Expected status 201 or 409");
});

if (response.status === 201) {
    client.test("Response should contain exchange data", function() {
        client.assert(response.body.id !== undefined, "Exchange ID should be present");
        client.assert(response.body.requester_id !== undefined, "Requester ID should be present");
        client.assert(response.body.owner_id !== undefined, "Owner ID should be present");
        client.assert(response.body.status !== undefined, "Status should be present");
    });
    
    // Guardar el ID del exchange creado para usar en tests posteriores
    client.global.set("testExchangeId", response.body.id);
    client.global.set("testExchangeStatus", response.body.status);
    client.log("✅ Exchange created with ID: " + response.body.id);
} else if (response.status === 409) {
    client.log("⚠️ Exchange already exists or conflict occurred");
}
%}

###

### Test 2: Get exchange by ID (using ID from Test 1)
GET {{baseUrl}}/exchanges/{{testExchangeId}}
Authorization: {{token}}

> {%
client.test("Get exchange should return 200 or 404", function() {
    client.assert(response.status === 200 || response.status === 404, "Expected status 200 or 404");
});

if (response.status === 200) {
    client.test("Response should contain exchange data", function() {
        client.assert(response.body.id !== undefined, "Exchange ID should be present");
        client.assert(response.body.status !== undefined, "Status should be present");
        client.assert(response.body.owner_book_ids !== undefined, "Offered book ID should be present");
        client.assert(response.body.requester_book_ids !== undefined, "Requested book ID should be present");
    });
}
%}

###

### Test 3: Get user's exchanges
GET {{baseUrl}}/exchanges/users/{{userId}}
Authorization: {{token}}

> {%
client.test("Get user exchanges should return 200", function() {
    client.assert(response.status === 200, "Expected status 200");
});

client.test("Response should be an array", function() {
    client.assert(Array.isArray(response.body), "Response should be an array");
});
%}

###

### Test 4: Get user's exchanges with status filter
GET {{baseUrl}}/exchanges/users/{{userId}}?status=PENDING
Authorization: {{token}}

> {%
client.test("Get user exchanges by status should return 200", function() {
    client.assert(response.status === 200, "Expected status 200");
});

client.test("Response should be an array", function() {
    client.assert(Array.isArray(response.body), "Response should be an array");
});
%}

###

### Test 5: Get exchanges as requester
GET {{baseUrl}}/exchanges/users/{{userId}}/as-requester
Authorization: {{token}}

> {%
client.test("Get exchanges as requester should return 200", function() {
    client.assert(response.status === 200, "Expected status 200");
});

client.test("Response should be an array", function() {
    client.assert(Array.isArray(response.body), "Response should be an array");
});
%}

###

### Test 6: Get exchanges as owner
GET {{baseUrl}}/exchanges/users/{{userId}}/as-owner
Authorization: {{token}}

> {%
client.test("Get exchanges as owner should return 200", function() {
    client.assert(response.status === 200, "Expected status 200");
});

client.test("Response should be an array", function() {
    client.assert(Array.isArray(response.body), "Response should be an array");
});
%}

###

### Test 7: Update exchange status - Accept (using ID from Test 1)
PUT {{baseUrl}}/exchanges/{{testExchangeId}}/status?userId={{userId}}
Content-Type: application/json
Authorization: {{token}}

{
  "status": "ACCEPTED"
}

> {%
client.test("Accept exchange should return 200 or 403", function() {
    client.assert(response.status === 200 || response.status === 403, "Expected status 200 or 403");
});

if (response.status === 200) {
    client.test("Response should contain updated status", function() {
        client.assert(response.body.status === "ACCEPTED", "Status should be updated to ACCEPTED");
    });
}
%}

###

### Test 8: Update exchange status - Reject (using ID from Test 1)
PUT {{baseUrl}}/exchanges/{{testExchangeId}}/status?userId={{userId}}
Content-Type: application/json
Authorization: {{token}}

{
  "status": "REJECTED"
}

> {%
client.test("Reject exchange should return 200 or 403", function() {
    client.assert(response.status === 200 || response.status === 403, "Expected status 200 or 403");
});

if (response.status === 200) {
    client.test("Response should contain updated status", function() {
        client.assert(response.body.status === "REJECTED", "Status should be updated to REJECTED");
    });
}
%}

###

### Test 9: Create counter offer (using ID from Test 1)
PUT {{baseUrl}}/exchanges/{{testExchangeId}}/counter-offer?userId={{userId}}
Content-Type: application/json
Authorization: {{token}}

{
  "owner_book_ids": ["{{ownerBookId}}"],
  "requester_book_ids": ["{{requesterBookId}}"]
}

> {%
client.test("Create counter offer should return 200 or 403", function() {
    client.assert(response.status === 200 || response.status === 403, "Expected status 200 or 403");
});

if (response.status === 200) {
    client.test("Response should contain counter offer data", function() {
        client.assert(response.body.id !== undefined, "Counter offer ID should be present");
    });
}
%}

###

### Test 10: Get pending exchanges count
GET {{baseUrl}}/exchanges/users/{{userId}}/pending-count
Authorization: {{token}}

> {%
client.test("Get pending exchanges count should return 200", function() {
    client.assert(response.status === 200, "Expected status 200");
});

client.test("Response should be a number", function() {
    client.assert(typeof response.body === 'number', "Response should be a number");
});
%}

###

### Test 11: Create exchange with same user
POST {{baseUrl}}/exchanges
Content-Type: application/json
Authorization: {{token}}

{
  "requester_id": "{{userId}}",
  "owner_id": "{{userId}}",
  "owner_book_ids": ["{{ownerBookId}}"],
  "requester_book_ids": ["{{requesterBookId}}"]
}

> {%
client.test("Exchange with same user should return 409", function() {
    client.assert(response.status === 409, "Expected status 409");
});
%}

###

### Test 12: Create exchange without authentication
POST {{baseUrl}}/exchanges
Content-Type: application/json
# Intencionalmente sin Authorization header

{
  "requester_id": "{{requesterId}}",
  "owner_id": "{{ownerId}}",
  "owner_book_ids": ["{{ownerBookId}}"],
  "requester_book_ids": ["{{requesterBookId}}"]
}

> {%
client.test("Exchange without auth should return 401 or 403 or 201", function() {
    client.assert(response.status === 401 || response.status === 403 || response.status === 201, 
                 "Expected status 401/403 (if auth enabled) or 201 (if auth disabled)");
});

client.log("🔒 Verified: Exchange creation authentication requirement");
%}

###

### Test 13: Update exchange with invalid status (using ID from Test 1)
PUT {{baseUrl}}/exchanges/{{testExchangeId}}/status?userId={{userId}}
Content-Type: application/json
Authorization: {{token}}

{
  "status": "INVALID_STATUS"
}

> {%
client.test("Invalid status should return 400", function() {
    client.assert(response.status === 400, "Expected status 400");
});
%}

###

### Test 14: Verify created exchange exists before cleanup
GET {{baseUrl}}/exchanges/{{testExchangeId}}
Authorization: {{token}}

> {%
client.test("Get created exchange should return 200", function() {
    client.assert(response.status === 200, "Expected status 200");
});

if (response.status === 200) {
    client.test("Response should contain the created exchange", function() {
        client.assert(response.body.id === client.global.get("testExchangeId"), "Exchange ID should match");
        client.assert(response.body.status !== undefined, "Status should be present");
    });
    
    client.log("✅ Exchange verified before cleanup: " + response.body.id);
}
%}

